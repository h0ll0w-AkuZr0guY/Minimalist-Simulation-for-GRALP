# 项目阅读指南

## 1. 项目概述

本项目是一个基于PyBullet物理引擎的机器人仿真系统，结合了PPO（Proximal Policy Optimization）强化学习算法，实现了机器人在动态环境中的自主导航和避障功能。

主要功能包括：
- 物理仿真环境构建
- 机器人建模与控制
- LIDAR传感器模拟
- PPO强化学习推理
- 相机控制与可视化
- 动态障碍物生成

## 2. 目录结构

```
├── ppo_api/              # PPO算法相关代码
│   ├── encoder.py        # 射线编码器，处理LIDAR数据
│   ├── inference.py      # PPO推理模块
│   ├── ppo_models.py     # PPO策略模型
│   └── config.json       # PPO配置文件
├── config_loader.py      # 配置加载器，合并仿真和PPO配置
├── camera_ctrl.py        # 相机控制器，处理可视化视角
├── robot.py              # 机器人模型，包含LIDAR和控制
├── scene.py              # 场景管理，包括墙壁和障碍物
├── task.py               # 主任务逻辑，协调各模块
├── simulation_config.json # 仿真配置文件
├── .gitignore           # Git忽略规则
└── README.md            # 项目说明文档
```

## 3. 核心模块功能

### 3.1 配置管理 (config_loader.py)
- 加载和合并`simulation_config.json`和`ppo_api/config.json`配置
- 计算派生参数，如LIDAR射线数量
- 提供全局`Config`命名空间，方便其他模块访问配置

### 3.2 场景管理 (scene.py)
- 创建物理世界和地面
- 生成边界墙壁
- 随机生成静态障碍物
- 创建和更新动态障碍物

### 3.3 机器人模型 (robot.py)
- 创建机器人主体，包含碰撞和视觉形状
- 模拟LIDAR传感器，生成距离数据
- 显示机器人朝向指示器
- 实现机器人控制接口

### 3.4 相机控制 (camera_ctrl.py)
- 管理仿真可视化视角
- 支持鼠标交互：右键旋转、左键平移、滚轮缩放
- 自动同步相机参数

### 3.5 PPO推理 (ppo_api/)
- **encoder.py**: 射线编码器，处理LIDAR数据，提取特征
- **inference.py**: PPO推理模块，加载模型并执行推理
- **ppo_models.py**: PPO策略网络，包含高斯策略和价值函数

### 3.6 主任务逻辑 (task.py)
- 初始化仿真环境
- 协调场景、机器人、相机和PPO推理
- 实现主仿真循环
- 处理目标生成和更新
- 实现碰撞检测和轨迹绘制

## 4. 模块间关系

```
┌─────────────────┐     ┌─────────────┐     ┌─────────────────┐
│   scene.py      │────▶│   robot.py  │────▶│  camera_ctrl.py │
└─────────────────┘     └─────────────┘     └─────────────────┘
         │                      │                      │
         │                      ▼                      │
         │              ┌─────────────┐               │
         └──────────────┤   task.py   │───────────────┘
                        └─────────────┘
                               │
                               ▼
                        ┌─────────────┐
                        │  ppo_api/   │
                        │ inference.py│
                        │ encoder.py  │
                        │ ppo_models.py│
                        └─────────────┘
                               │
                               ▼
                        ┌─────────────┐
                        │ config.json │
                        └─────────────┘
```

## 5. 工作流程

1. **初始化阶段**
   - `task.py`调用`p.connect(p.GUI)`启动PyBullet仿真
   - 初始化`Scene`、`Robot`、`CameraController`和`PPOInference`实例
   - 生成初始目标位置

2. **主仿真循环**
   - 以PPO的时间步长（`ppo.cfg.dt`）运行控制
   - 获取机器人状态和LIDAR数据
   - 构建视线（LOS）点，选择局部目标
   - 计算目标方向和距离
   - 调用PPO推理生成动作
   - 应用控制指令到机器人
   - 检测碰撞并更新机器人颜色
   - 绘制轨迹
   - 更新场景、相机和仿真
   - 控制仿真速度

3. **目标更新**
   - 当机器人到达目标时，采样新的目标位置
   - 更新目标标记

## 6. 配置说明

### 6.1 仿真配置 (simulation_config.json)
主要配置项包括：
- `TIMESTEP`: 物理仿真时间步长
- `GRAVITY`: 重力加速度
- `ROBOT_RADIUS/HEIGHT`: 机器人尺寸
- `LIDAR_*`: LIDAR传感器参数
- `MAP_SIZE`: 地图大小
- `STATIC/DYNAMIC_OBSTACLE_*`: 障碍物参数
- `CAM_*`: 相机初始参数
- `MOUSE_SENSITIVITY_*`: 鼠标交互灵敏度

### 6.2 PPO配置 (ppo_api/config.json)
主要配置项包括：
- `vx_max/omega_max`: 速度限制
- `dt`: 控制时间步长
- `patch_meters`: 感知范围
- `ray_max_gap`: 最大射线间隔
- `execution_provider`: 执行设备（cpu/cuda/tensorrt）

## 7. 如何运行项目

1. 确保安装了必要的依赖：
   ```bash
   pip install numpy pybullet onnxruntime
   ```

2. 运行主程序：
   ```bash
   python task.py
   ```

3. 使用鼠标交互：
   - 右键拖动：旋转视角
   - 左键拖动：平移视角
   - 滚轮：缩放视角

4. 观察机器人行为：
   - 机器人会自动规划路径，避开障碍物
   - 碰撞时机器人会变为绿色
   - 轨迹会显示机器人的运动路径

## 8. 核心算法和技术

### 8.1 LIDAR数据处理
- 使用射线投射模拟LIDAR传感器
- 通过膨胀算法处理障碍物距离，确保安全距离
- 构建视线（LOS）点用于路径规划

### 8.2 路径规划
- 基于LOS点选择局部目标
- 结合全局目标和障碍物信息
- 动态调整目标，实现避障

### 8.3 PPO强化学习
- 多查询多头注意力机制处理LIDAR数据
- 高斯策略网络生成动作分布
- Tanh压缩确保动作在安全范围内

## 9. 项目扩展建议

1. 增加不同类型的机器人模型
2. 实现更多传感器，如相机或IMU
3. 添加不同的环境和任务场景
4. 实现训练功能，支持在线学习
5. 增加多机器人协作功能

## 10. 关键函数和流程

### 10.1 主流程 (task.py)
- `main()`: 主函数，初始化和运行仿真
- `_build_los_points()`: 构建视线点
- `_select_local_target()`: 选择局部目标
- `_direction_to_target()`: 计算目标方向

### 10.2 PPO推理 (inference.py)
- `PPOInference.infer()`: 执行PPO推理
- `_build_pose_features()`: 构建姿态特征
- `_validate_and_normalize_rays_m()`: 验证和归一化LIDAR数据

### 10.3 机器人控制 (robot.py)
- `Robot.get_lidar_data()`: 获取LIDAR数据
- `Robot.apply_control()`: 应用控制指令
- `Robot.update_heading_indicator()`: 更新朝向指示器

## 11. 故障排除

### 11.1 常见问题

1. **PPO推理失败**
   - 检查`ppo_api/config.json`配置是否正确
   - 确保ONNX模型文件存在
   - 检查`execution_provider`是否与硬件兼容

2. **仿真运行缓慢**
   - 降低`LIDAR_NUM_RAYS`减少计算量
   - 减少障碍物数量
   - 使用`execution_provider: "cuda"`启用GPU加速

3. **机器人碰撞频繁**
   - 增加`OBSTACLE_INFLATION_EXTRA`参数
   - 降低机器人速度
   - 增加LIDAR射线数量

### 11.2 调试技巧

1. 启用`DEBUG_MODE: true`查看调试信息
2. 使用PyBullet的GUI调试功能
3. 检查日志输出，查看PPO推理结果
4. 调整相机视角，观察机器人周围环境

通过阅读本指南，您应该对项目的结构、功能和工作流程有了全面的了解。建议按照以下顺序深入学习代码：
1. 先阅读`simulation_config.json`和`config_loader.py`了解配置系统
2. 然后学习`scene.py`和`robot.py`理解物理世界构建
3. 接着研究`camera_ctrl.py`了解可视化部分
4. 最后阅读`task.py`和`ppo_api/`代码，掌握核心逻辑

祝您学习愉快！